using System.Collections;
using UnityEngine;

public class ElevatorController : MonoBehaviour
{
    [System.Serializable]
    public class ElevatorPoint
    {
        public GameObject buton;                   // TÄ±klanacak buton (Prefab)
        public Transform hedefKonum;               // Gidilecek konum
        public bool ozelButon;                     // NPC sadece bunlara tÄ±klayabilir
        public GameObject otomatikTiklanacakButon; // EÄŸer atanÄ±rsa â†’ bu buton da otomatik Ã§alÄ±ÅŸÄ±r
        public FlagKod kontrolDosyasi;              // Sadece AI iÃ§in flag, hareketi etkilemez
    }

    [Header("AsansÃ¶r AyarlarÄ±")]
    [SerializeField] private GameObject asansor;
    [SerializeField] private float hareketHizi = 1f;
    [SerializeField] private ElevatorPoint[] noktalar;

    [Header("Ses AyarlarÄ±")]
    public AudioSource hareketSesi;
    public AudioSource durmaSesi;

    [Header("Debug / NPC Kontrol")]
    public bool npcButonaTiklandi = false;
    public bool isMoving = false;

    [Header("Buton Kilidi")]
    public float durduktanSonraKilitSuresi = 3f;
    private bool butonKilidi = false;

    private bool fizikselHareketBaslasin = false;
    private int hedefIndex = -1;
    private bool sesCaldi = false;
    private Camera mainCam;

    void Start()
    {
        mainCam = Camera.main;
        StartCoroutine(NPCButonKontrolRoutine());
    }

    void Update()
    {
        RaycastKontrol();

        if (isMoving && hedefIndex >= 0 && fizikselHareketBaslasin)
        {
            ElevatorPoint point = noktalar[hedefIndex];

            if (hareketSesi != null && !hareketSesi.isPlaying && !sesCaldi)
            {
                hareketSesi.loop = true;
                hareketSesi.Play();
                sesCaldi = true;
            }

            Vector3 hedefPozisyon = point.hedefKonum.position;
            asansor.transform.position = Vector3.MoveTowards(
                asansor.transform.position,
                hedefPozisyon,
                hareketHizi * Time.deltaTime
            );

            if (Vector3.Distance(asansor.transform.position, hedefPozisyon) < 0.01f)
            {
                StartCoroutine(HareketiBitir());
            }
        }
    }

    /// <summary>
    /// Oyuncu raycast ile tÃ¼m butonlara tÄ±klayabilir.
    /// </summary>
    void RaycastKontrol()
    {
        if (butonKilidi) return; // ðŸ”’ Kilitliyse tÄ±klanamaz

        if (Input.GetKeyDown(KeyCode.E))
        {
            Ray ray = new Ray(mainCam.transform.position, mainCam.transform.forward);
            if (Physics.Raycast(ray, out RaycastHit hit, 1.7f))
            {
                GameObject hedefObje = hit.collider.gameObject;

                for (int i = 0; i < noktalar.Length; i++)
                {
                    if (noktalar[i].buton == hedefObje)
                    {
                        ButonaBasildi(i);

                        // EÄŸer otomatik buton atanmÄ±ÅŸsa â†’ onu da Ã§alÄ±ÅŸtÄ±r
                        if (noktalar[i].otomatikTiklanacakButon != null)
                        {
                            for (int j = 0; j < noktalar.Length; j++)
                            {
                                if (noktalar[j].buton == noktalar[i].otomatikTiklanacakButon)
                                {
                                    ButonaBasildi(j);
                                    break;
                                }
                            }
                        }
                        break;
                    }
                }
            }
        }
    }

    /// <summary>
    /// NPC sadece Ã¶zel butonlara (ozelButon = true) tÄ±klayabilir.
    /// </summary>
    private IEnumerator NPCButonKontrolRoutine()
    {
        WaitForSeconds delay = new WaitForSeconds(0.2f);

        while (true)
        {
            if (butonKilidi)
            {
                yield return delay;
                continue;
            }

            foreach (var point in noktalar)
            {
                if (point.buton != null && point.ozelButon)
                {
                    Collider[] hits = Physics.OverlapSphere(point.buton.transform.position, 0.5f);
                    foreach (Collider hit in hits)
                    {
                        if (hit.CompareTag("NPC"))
                        {
                            for (int i = 0; i < noktalar.Length; i++)
                            {
                                if (noktalar[i].buton == point.buton)
                                {
                                    ButonaBasildi(i);
                                    StartCoroutine(NPCButonaTiklamaFlag());

                                    // EÄŸer otomatik buton atanmÄ±ÅŸsa â†’ onu da Ã§alÄ±ÅŸtÄ±r
                                    if (noktalar[i].otomatikTiklanacakButon != null)
                                    {
                                        for (int j = 0; j < noktalar.Length; j++)
                                        {
                                            if (noktalar[j].buton == noktalar[i].otomatikTiklanacakButon)
                                            {
                                                ButonaBasildi(j);
                                                break;
                                            }
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            yield return delay;
        }
    }

    private void ButonaBasildi(int index)
    {
        if (butonKilidi) return; // ðŸ”’ Ekstra gÃ¼venlik

        hedefIndex = index;
        isMoving = true;
        sesCaldi = false;
        StartCoroutine(FizikselHareketiBaslat());

        // âœ… Sadece flag aÃ§ (hareketi etkilemez)
        if (noktalar[index].kontrolDosyasi != null)
            noktalar[index].kontrolDosyasi.aktifMi = true;
    }

    private IEnumerator FizikselHareketiBaslat()
    {
        yield return new WaitForSeconds(2f);
        fizikselHareketBaslasin = true;
    }

    private IEnumerator HareketiBitir()
    {
        fizikselHareketBaslasin = false;

        if (hareketSesi != null && hareketSesi.isPlaying)
            hareketSesi.Stop();

        if (durmaSesi != null)
            durmaSesi.Play();

        yield return new WaitForSeconds(2f);

        // âœ… Hareket bittiÄŸinde flag kapat
        if (hedefIndex >= 0 && noktalar[hedefIndex].kontrolDosyasi != null)
            noktalar[hedefIndex].kontrolDosyasi.aktifMi = false;

        isMoving = false;
        hedefIndex = -1;
        sesCaldi = false;

        // ðŸ”’ AsansÃ¶r durduktan sonra butonlarÄ± kilitle
        St...

<...etc...>
