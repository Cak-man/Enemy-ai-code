using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.AI;
using UnityEngine.SceneManagement;

public class enemyAI : MonoBehaviour
{
    [Header("AI References")]
    public NavMeshAgent ai;
    public Animator aiAnim;
    public Transform player;

    [Header("HÄ±zlar")]
    public float walkSpeed, chaseSpeed;

    [Header("Idle SÃ¼releri")]
    public float minIdleTime, maxIdleTime;

    [Header("Mesafeler")]
    public float detectionDistance, catchDistance, searchDistance;

    [Header("Chase/Search SÃ¼releri")]
    public float minChaseTime, maxChaseTime;
    public float minSearchTime, maxSearchTime;

    [Header("Jumpscare")]
    public float jumpscareTime;
    public string deathScene;



    [Header("Sesler")]
    public AudioClip walkClip;
    public AudioClip runClip;
    public AudioClip jumpscareClip;

    private AudioSource audioSource;

    [Header("AsansÃ¶r BaÄŸlantÄ±sÄ±")]
    public bool asansoreBindi = false;
    public int hedefKat;
    public DurmaKapÄ±Etiketleyici durmaKod;
    [System.Serializable]
    public class Waypoint
    {
        public Transform point;
        public float waitTime = 2f;

        [Header("Opsiyonel Animasyon")]
        public Animator extraAnimator;
        public string triggerName;

        [Header("Opsiyonel Rotasyon")]
        public bool kullanOzelRotasyon = false;  // âœ… BURAYA EKLENECEK
        public Vector3 ozelRotasyon;             // âœ… BURAYA EKLENECEK
    }

    [System.Serializable]
    public class KatWaypointleri
    {
        public string katIsmi;
        public List<Waypoint> waypointler = new List<Waypoint>();

        [Header("Kat Bekleme SÃ¼resi (saniye)")]
        public float katBeklemeSuresi = 10f;
    }

    [Header("Katlara GÃ¶re Waypointler")]
    public List<KatWaypointleri> katlar = new List<KatWaypointleri>();

    private Waypoint currentWaypoint;
    public bool walking, chasing, searching;
    public bool hasJumpscared = false;

    public Vector3 rayCastOffset;
    private Vector3 dest;
    private float aiDistance;

    private float orjinalDetectionDistance;
    private float orjinalCatchDistance;
    private float orjinalSearchDistance;
    private float orjinalChaseSpeed;

    private int currentKatIndex = 0;
    private float katTimer;

    void Awake()
    {
        // ðŸ”¸ NavMeshAgent kontrolÃ¼      
        if (ai == null)
        {
            ai = GetComponent<NavMeshAgent>();
            if (ai == null)
            {
                ai = gameObject.AddComponent<NavMeshAgent>();
                Debug.LogWarning($"{name} nesnesine otomatik NavMeshAgent eklendi!");
            }
            else
            {
                Debug.Log($"{name} nesnesindeki mevcut NavMeshAgent otomatik atandÄ±.");
            }
        }

        // ðŸ”¸ Animator kontrolÃ¼      
        if (aiAnim == null)
        {
            aiAnim = GetComponent<Animator>();
            if (aiAnim == null)
            {
                aiAnim = GetComponentInChildren<Animator>();
                if (aiAnim != null)
                {
                    Debug.Log($"{name} nesnesinin alt objesinden Animator otomatik atandÄ±.");
                }
                else
                {
                    Debug.LogWarning($"{name} nesnesinde Animator bulunamadÄ±! LÃ¼tfen ekleyin.");
                }
            }
            else
            {
                Debug.Log($"{name} nesnesindeki mevcut Animator otomatik atandÄ±.");
            }
        }

        // ðŸ”¸ AudioSource kontrolÃ¼      
        audioSource = GetComponent<AudioSource>();
        if (audioSource == null)
        {
            audioSource = gameObject.AddComponent<AudioSource>();
            audioSource.loop = false;
            audioSource.playOnAwake = false;
            Debug.Log($"{name} nesnesine otomatik AudioSource eklendi.");
        }

        // ðŸŽ§ AudioSource ayarlarÄ± â€” ðŸ”¹ BU KISIM YENÄ° EKLENDÄ°  
        audioSource.spatialBlend = 1f; // 3D ses  
        audioSource.maxDistance = 10f; // Maksimum duyulma mesafesi  
        audioSource.rolloffMode = AudioRolloffMode.Linear; // Sesin azalÄ±m tipi  
    }

    void Start()
    {
        walking = true;
        audioSource.loop = true;

        if (katlar.Count > 0)
        {
            katTimer = katlar[currentKatIndex].katBeklemeSuresi;
            SelectNextWaypoint();
        }

        orjinalDetectionDistance = detectionDistance;
        orjinalCatchDistance = catchDistance;
        orjinalSearchDistance = searchDistance;
        orjinalChaseSpeed = chaseSpeed;
    }

    void Update()
    {
        if (hasJumpscared) return;
        if (player == null || ai == null || !ai.isOnNavMesh) return;

        Vector3 direction = (player.position - transform.position).normalized;
        RaycastHit hit;
        aiDistance = Vector3.Distance(player.position, transform.position);

        // Oyuncuyu gÃ¶rme
        if (Physics.Raycast(transform.position + rayCastOffset, direction, out hit, detectionDistance))
        {
            if (hit.collider.CompareTag("Player"))
            {
                walking = false;
                StopAllCoroutines();
                StartCoroutine(searchRoutine());
                searching = true;
            }
        }

        // Arama
        if (searching)
        {
            ai.speed = 0;
            ResetAnim();
            aiAnim.SetTrigger("search");

            if (aiDistance <= searchDistance)
            {
                StopAllCoroutines();
                StartCoroutine(chaseRoutine());
                chasing = true;
                searching = false;
            }
        }

        // Kovalamaca
        if (chasing)
        {
            if (!ai.isOnNavMesh) return;

            dest = player.position;
            ai.SetDestination(dest);
            ai.speed = chaseSpeed;

            ResetAnim();
            aiAnim.SetTrigger("sprint");
            PlayLoop(runClip);

            if (aiDistance <= catchDistance && !hasJumpscared)
            {
                hasJumpscared = true;
                PlayerMovement pm = player.GetComponent<PlayerMovement>();
                if (pm != null) pm.enabled = false;

                ai.isStopped = true;
                ai.ResetPath();


                ResetAnim();
                aiAnim.SetTrigger("jumpscare");
                PlayOnce(jumpscareClip);

                StartCoroutine(FaceEachOther());
                StartCoroutine(deathRoutine());

                chasing = false;
            }
        }

        // Kat sÃ¼resi kontrolÃ¼
        if (walking && katlar.Count > 0)
        {
            katTimer -= Time.deltaTime;
            if (katTimer <= 0f)
            {
                currentKatIndex = (currentKatIndex + 1) % katlar.Count;
                katTimer = katlar[currentKatIndex].katBeklemeSuresi;
                SelectNextWaypoint();
            }
        }
    }

    void ResetAnim()
    {
        aiAnim.ResetTrigger("walk");
        aiAnim.ResetTrigger("idle");
        aiAnim.ResetTrigger("search");
        aiAnim.ResetTrigger("sprint");
        aiAnim.ResetTrigger("jumpscare");
        aiAnim.ResetTrigger("kapiAc");
        aiAnim.ResetTrigger("butonaBas");
    }

    void PlayLoop(AudioClip clip)
    {
        if (clip != null && (audioSource.clip != clip || !audioSource.isPlaying))
        {
            audioSource.clip = clip;
            audioSource.loop = true;
            audioSource.Play();
        }
    }

    void PlayOnce(AudioClip clip)
    {
        if (clip != null)
        {
            audioSource.loop = false;
            audioSource.clip = clip;
            audioSource.Play();
        }
    }

    void StopSound()
    {
        audioSource.Stop();
        audioSource.clip = null;
    }

    void SelectNextWaypoint()
    {
        KatWaypointleri kat = katlar[currentKatIndex];
        if (kat.waypointler.Count > 0)
        {
            currentWaypoint = kat.waypointler[Random.Range(0, kat.waypointler.Count)];
            StartCoroutine(GoToWaypointRoutine(currentWaypoint));
        }
    }


    IEnumerator GoToWaypointRoutine(Waypoint wp)
    {
        if (ai == null || !ai.isOnNavMesh) yield break;

        walking = true;
        ai.SetDestination(wp.point.position);
        ai.speed = walkSpeed;

        ResetAnim();
        aiAnim.SetTrigger("walk");
        PlayLoop(walkClip);

        while (ai.pathPending || ai.remainingDistance > ai.stoppingDistance)
        {
            yield return null;
        }

        ResetAnim();
        aiAnim.SetTrigger("idle");
        StopSound();

        // âœ… Waypoint rotasyon kontrolÃ¼
        if (wp.kullanOzelRotasyon)
        {
            transform.rotation = Quaternion.Euler(wp.ozelRotasyon);
        }
        else
        {
            transform.rotation = wp.point.rotation;
        }

        // Opsiyonel animasyon
        if (!string.IsNullOrEmpty(wp.triggerName))
        {
            if (wp.extraAnimator != null) wp.extraAnimator.SetTrigger(wp.triggerName);
            else aiAnim.SetTrigger(wp.triggerName);
        }

        yield return new WaitForSeconds(wp.waitTime);

        SelectNextWaypoint();
    }
    IEnumerator searchRoutine()
    {
        yield return new WaitForSeconds(Random.Range(minSearchTime, maxSearchTime));
        searching = false;
        SelectNextWaypoint();
    }

    IEnumerator chaseRoutine()
    {
        yield return new WaitForSeconds(Random.Range(minChaseTime, maxChaseTime));
        chasing = false;
        SelectNextWaypoint();
    }

    IEnumerator deathRoutine()
    {
        yield return new WaitForSeconds(jumpscareTime);
        SceneManager.LoadScene(deathScene);
    }

    IEnumerator FaceEachOther()
    {
        float duration = 0.1f;
        float elapsed = 0f;

        Quaternion playerStartRot = player.rotation;
        Quaternion enemyStartRot = transform.rotation;

        Vector3 playerDir = transform.position - player.position;
        Quaternion playerTargetRot = Quaternion.LookRotation(new Vector3(playerDir.x, 0, playerDir.z));

        Vector3 enemyDir = player.position - transform.position;
        Quaternion enemyTargetRot = Quaternion.LookRotation(new Vector3(enemyDir.x, 0, enemyDir.z));

        while (elapsed < duration)
        {
            float t = elapsed / duration;
            player.rotation = Quaternion.Slerp(playerStartRot, playerTargetRot, t);
            transform.rotation = Quaternion.Slerp(enemyStartRot, enemyTargetRot, t);

            elapsed += Time.deltaTime;
            yield return null;
        }

        player.rotation = playerTargetRot;
        transform.rotation = enemyTargetRot;
    }

    private void OnTriggerEnter(Collider other)
    {
        if (other.CompareTag("Door"))
        {
            ResetAnim();
            aiAnim.SetTrigger("kapiAc");

            Door door = other.GetComponentInChildren<Door>();
            if (door != null)
            {
                door.open = true;
            }
        }

        if (other.CompareTag("AsansÃ¶rButon"))
        {
            if (Vector3.Distance(transform.position, other.transform.position) <= 0.5f)
            {
                ResetAnim();
                aiAnim.SetTrigger("butonaBas");
            }
        }
    }

    public void PasifEt()
    {
        detectionDistance = 0f;
        catchDistance = 0f;
        searchDistance = 0f;
        chaseSpeed = 0f;
    }

    public void AktifEt()
    {
        detectionDistance = orjinalDetectionDistance;
        catchDistance = orjinalCatchDistance;
        searchDistance = orjinalSearchDistance;
        chaseSpeed = orjinalChaseSpeed;
    }
}
